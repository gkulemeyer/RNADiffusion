# RNADiffusion

RNADiffusion is a diffusion-based **seq2struct model** for **RNA secondary structure prediction**.

The model takes an RNA sequence as input, builds a 2D representation via an outer product of sequence concatenates it with 2D noise, and uses a **diffusion model** to generate a contact map representing RNA secondary structure. 
Current model: Multinomial Diffusion base. (No log space). Full NLL hardcoded beta_0.


This repository is intended for model development, training, and experimentation.
 
    -- Data--
    ArchiveII_max_128
                random split 70/15/15 

    -- training setup--
    timesteps: {5, 10, 25, 50}
    epochs: {5, 10, 25, 50}

    -- Ensemble analysis -- 
    50 samples - 20 trials 
 
---

## Usage

This diffusion model and the utils are in the `src` folder. The backbone  model is written in `src/layers`. 

### Train
The **train.py** scripts takes a base_config to set the parameters of the trainings. Currently the experiments made can vary the number of timesteps, and the number of epochs (without checkpoints). The trained models are saved in `logs/`, in folders with format `exp_T{timesteps}_E{epochs}_{date}`. In that folders is saved the `config.json` file, the `best_model.pt`, the `last_model.pt` and a `metrics.csv` report.

### Test

The **test.py** file evaluates all the `best_model.pt` models in the logs directory, and saves `logs/all_test_summary.csv`, with all the F1 values.

### Ensemble: Test file

The `ensemble_generator.py` script takes NUM_SAMPLES and saves in every experiment directory a `raw_samples` folder filled with all the `seq_id.pt` in the test file, containig a dictionary with samples of the outputs generated by the model.

The `ensemble_stats.py` script takes NUM_TRIALS, and NUM_CONSENSUS to make stats over the ensemble, and returns the `ensemble_stats_{NUM_TRIALS}_trials.csv`. Here, the NUM_TRIALS stands for the number of executions for a given consensus, and NUM_CONSENSUS is the number of samples used.

For example, if NUM_TRIALS = 2 and NUM_CONSENSUS = 5, take 5 samples, obtain consensus and calculate F1. Then repeat 2 times and average.

### Notebooks
    1-3. Model dev.
    4. Training loss analysis.
    5. Ensemble analysis.
 
   

## TODO

- Triangular CM - padding - Loss 

- Loss implementation and evaluation (one timestep / every timestep / stochastic timesteps )
- Implement consensus Loss (MC O?)
- ADD checkpoints handling (config)
- Refactor train/ test script
- Create requirements